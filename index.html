<!doctype html>
<html lang="es-ES">
<head>
    <!-- ============== METAETIQUETAS ORIGINALES DE LA CALCULADORA ============== -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="La Calculadora de Facundo con herramientas avanzadas como un lector de números.">
    <meta name="author" content="Hector Daniel Ayarachi Fuentes">
    <meta name="theme-color" content="#66FF66">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='5' y='5' width='90' height='90' rx='15' fill='%2366FF66'/><text x='50' y='55' font-size='40' text-anchor='middle' fill='%23000' font-family='Arial, sans-serif'>FC</text></svg>">
    <title>Calculadora Facundo 🧮</title>
    
    <!-- Metadatos Open Graph para redes sociales -->
    <meta property="og:title" content="Calculadora Facundo 🧮">
    <meta property="og:description" content="La Calculadora de Facundo: rápida, atractiva y con herramientas avanzadas.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://hectordanielayarachifuentes.github.io/CALCULADORA-FACUNDO/">
    <meta property="og:image" content="https://hectordanielayarachifuentes.github.io/CALCULADORA-FACUNDO/img/Inicio%20de%20calculadora.jpeg">

    <!-- ============== RECURSOS PARA LA NUEVA BARRA LATERAL Y MODAL ============== -->
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome para los iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Google Fonts para el lector de números -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- ============== ESTILOS DE LA CALCULADORA (CARGADO AL FINAL PARA TENER PRIORIDAD) ============== -->
    <link rel="stylesheet" href="style.css">

    <!-- ============== ESTILOS PARA LA NUEVA BARRA LATERAL Y LECTOR DE NÚMEROS ============== -->
    <style>
        /* ESTOS ESTILOS SE APLICAN A LOS NUEVOS COMPONENTES SIN AFECTAR LA CALCULADORA */
        :root {
            --ln-color-fondo: #f8f9fa;
            --ln-color-texto-principal: #333;
            --ln-color-entero: #0d6efd;
            --ln-color-decimal: #198754;
            --ln-color-coma: #dc3545;
            --ln-color-placeholder: #6c757d;
        }

        .sidebar-wrapper {
            position: fixed; top: 20px; left: 20px; z-index: 1050;
        }
        .bubble-main {
            width: 65px; height: 65px;
        }
        .bubble-btn {
            width: 55px; height: 55px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            padding: 0; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); transition: all 0.2s ease;
        }
        .bubble-btn:hover {
            transform: scale(1.1); box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }
        .bubble-btn i {
            font-size: 1.5rem;
        }
        .bubble-sub {
            width: 45px; height: 45px;
        }
        .bubble-sub i {
            font-size: 1.2rem;
        }
        .bubble-main {
            transition: transform 0.3s ease-in-out;
        }
        .bubble-main[aria-expanded="true"] {
            transform: rotate(45deg);
        }

        /* ESTILOS PARA EL LECTOR DE NÚMEROS (DENTRO DEL MODAL) */
        .modal-body .input-section { margin-bottom: 2rem; text-align: center; }
        .modal-body .input-section label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 1.1rem; }
        .modal-body .input-section input {
            font-family: 'Roboto Mono', monospace; padding: 0.75rem; border: 1px solid #ccc;
            border-radius: 8px; font-size: 1.5rem; width: 100%; max-width: 400px; text-align: center;
        }

        .modal-body .card {
            background: #ffffff; padding: 1.5rem; border-radius: 12px; border: 1px solid #e0e0e0;
            margin-bottom: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.05); color: #000;
        }
        .modal-body .card h2 {
            margin-top: 0; margin-bottom: 1rem; font-size: 1.25rem;
            color: var(--ln-color-texto-principal); border-bottom: 1px solid #eee; padding-bottom: 0.75rem;
        }

        .modal-body .result-box {
            padding: 1rem; border-radius: 8px; min-height: 50px; display: flex; align-items: center;
            justify-content: center; background-color: var(--ln-color-fondo); font-size: 1.2rem;
            font-family: 'Roboto', sans-serif; transition: background-color 0.3s;
        }
        .modal-body .placeholder-text { color: var(--ln-color-placeholder); font-style: italic; }

        .modal-body .phonetic-box {
            font-family: 'Roboto Mono', monospace; font-weight: 700; letter-spacing: 1px;
            word-spacing: 10px; flex-wrap: wrap;
        }
        .modal-body .phonetic-box .palabra-fonetica {
            padding: 2px 5px; transition: background-color 0.2s, color 0.2s; border-radius: 4px;
        }

        .modal-body .svg-box { padding: 0; background-color: transparent; overflow-x: auto; }
        .modal-body .svg-box svg { display: block; width: 100%; max-height: 250px; }
        .modal-body .svg-etiqueta-principal {
            font-family: 'Roboto', sans-serif; font-size: 18px; font-weight: 700;
            text-transform: uppercase; fill: #555;
        }
        .modal-body .svg-etiqueta-vertical {
            font-family: 'Roboto', sans-serif; font-size: 14px;
            text-transform: uppercase; fill: var(--ln-color-decimal);
        }
        .modal-body .svg-numero { font-family: 'Roboto Mono', monospace; font-size: 5rem; font-weight: 700; }

        .modal-body .highlight {
            background-color: var(--ln-color-entero) !important; color: white !important;
            fill: white !important; transition: background-color 0.1s, color 0.1s;
        }

        .modal-body .play-btn {
            margin-top: 1rem; padding: 0.5rem 1rem; font-size: 1rem; border-radius: 20px;
            border: 1px solid #ccc; background: #fff; cursor: pointer; color: #333;
            transition: background-color 0.2s, transform 0.2s;
        }
        .modal-body .play-btn:hover { background-color: #f0f0f0; transform: translateY(-2px); }
    </style>
</head>

<body>
    <!-- ============== CONTENIDO ORIGINAL DE LA CALCULADORA ============== -->
    <main id="contenedor" class="calculator-container" role="main">
        <header role="banner">
            <h1>LA<br>CALCULADORA<br>DE <span>FACUNDO</span></h1>
            <p class="subtitle">Un proyecto de <a href="https://github.com/HectorDanielAyarachiFuentes" target="_blank" rel="noopener">Facundo Killer</a></p>
        </header>
        <section aria-label="Pantalla de la calculadora">
            <div id="display" class="display" role="textbox" aria-live="polite">0</div>
        </section>
        <section aria-label="Teclado y pantalla de operaciones">
            <div id="cuerpoteclado" class="keyboard-container">
                <div id="teclado" class="keyboard" role="grid">
                    <button class="keyboard__button keyboard__button--special keyboard__button--double-width" data-action="view-screen" aria-label="Ver pantalla de resultados">Ver<br>Pantalla</button>
                    <button id="tcal" class="keyboard__button keyboard__button--equals keyboard__button--triple-width" data-action="calculate" aria-label="Calcular">=</button>
                    <button class="keyboard__button keyboard__button--number" data-value="7">7</button>
                    <button class="keyboard__button keyboard__button--number" data-value="8">8</button>
                    <button class="keyboard__button keyboard__button--number" data-value="9">9</button>
                    <button id="tmas" class="keyboard__button keyboard__button--operator" data-value="+">+</button>
                    <button id="tmen" class="keyboard__button keyboard__button--operator" data-value="-">-</button>
                    <button class="keyboard__button keyboard__button--number" data-value="4">4</button>
                    <button class="keyboard__button keyboard__button--number" data-value="5">5</button>
                    <button class="keyboard__button keyboard__button--number" data-value="6">6</button>
                    <button id="tpor" class="keyboard__button keyboard__button--operator" data-value="x">×</button>
                    <button id="tdiv" class="keyboard__button keyboard__button--operator" data-value="/">÷</button>
                    <button class="keyboard__button keyboard__button--number" data-value="1">1</button>
                    <button class="keyboard__button keyboard__button--number" data-value="2">2</button>
                    <button class="keyboard__button keyboard__button--number" data-value="3">3</button>
                    <button id="tpri" class="keyboard__button keyboard__button--equals" data-action="primos" aria-label="Factores Primos">|</button>
                    <button id="trai" class="keyboard__button keyboard__button--equals" data-action="raiz" aria-label="Raíz Cuadrada">√</button>
                    <button class="keyboard__button keyboard__button--number keyboard__button--double-width" data-value="0">0</button>
                    <button id="tcom" class="keyboard__button keyboard__button--number" data-value=",">,</button>
                    <button class="keyboard__button keyboard__button--operator" data-action="clear" aria-label="Limpiar Todo">C</button>
                    <button class="keyboard__button keyboard__button--operator" data-action="delete" aria-label="Borrar">⌫</button>
                </div>
                <div id="salida" class="output-screen" role="region" aria-live="polite"></div>
                <nav id="divvolver" class="bottom-nav" aria-label="Controles de resultados">
                    <button id="volver" class="bottom-nav__button bottom-nav__button--arrow" data-action="hide-screen" aria-label="Volver al teclado">↩</button>
                    <button id="botexp" class="bottom-nav__button" data-action="divide-expanded" aria-label="Ver división expandida">DIV EXPAND.</button>
                    <button id="botnor" class="bottom-nav__button" data-action="divide-normal" aria-label="Ver división normal">DIV NORMAL</button>
                </nav>
            </div>
        </section>
    </main>

    <button id="history-toggle-btn" class="history-toggle-btn" aria-label="Mostrar u ocultar historial" aria-controls="history-panel">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M13,3A9,9,0,0,0,4,12H1L4.89,15.89L4.96,16.03L9,12H6A7,7,0,0,1,13,5V8L18,4L13,0V3M12,12.5A1.5,1.5,0,0,0,10.5,14A1.5,1.5,0,0,0,12,15.5A1.5,1.5,0,0,0,13.5,14A1.5,1.5,0,0,0,12,12.5Z"/></svg>
    </button>
    <aside id="history-panel" class="history-panel" role="complementary" aria-hidden="true">
        <header class="history-panel__header">
            <h2 id="history-title" class="history-panel__title">Historial</h2>
            <button id="clear-history-btn" class="history-panel__clear-btn">Limpiar</button>
        </header>
        <ul id="history-list" class="history-panel__list" role="list" aria-labelledby="history-title"></ul>
    </aside>

    <!-- ============== NUEVOS ELEMENTOS: BARRA LATERAL Y MODAL ============== -->
    <div class="sidebar-wrapper">
        <button class="btn btn-primary bubble-btn bubble-main" type="button" data-bs-toggle="collapse" data-bs-target="#mainOptions" aria-expanded="false" aria-controls="mainOptions" title="Abrir herramientas">
            <i class="fa-solid fa-screwdriver-wrench"></i>
        </button>
        <div class="collapse" id="mainOptions">
            <div class="d-flex flex-column gap-3 mt-3">
                <div class="d-flex flex-column align-items-start">
                    <button class="btn btn-success bubble-btn" type="button" data-bs-toggle="collapse" data-bs-target="#mathSubOptions" aria-expanded="false" aria-controls="mathSubOptions" title="Matemáticas">
                        <i class="fa-solid fa-calculator"></i>
                    </button>
                    <div class="collapse mt-2 ps-4" id="mathSubOptions">
                        <div class="d-flex flex-column gap-2">
                            <button class="btn btn-success bubble-btn bubble-sub" data-modal-target="readNumbers" title="Lector de Números Avanzado">
                                <i class="fa-solid fa-spell-check"></i>
                            </button>
                            <button class="btn btn-success bubble-btn bubble-sub" data-modal-target="geometry" title="Geometría">
                                <i class="fa-solid fa-draw-polygon"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <button class="btn btn-secondary bubble-btn" data-modal-target="config" title="Configuración">
                    <i class="fa-solid fa-gears"></i>
                </button>
                 <button class="btn btn-info bubble-btn" data-modal-target="help" title="Ayuda">
                    <i class="fa-solid fa-circle-question"></i>
                </button>
            </div>
        </div>
    </div>
    <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fs-4" id="infoModalLabel">Título</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="infoModalBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ============== SCRIPTS (ORIGINALES + NUEVOS) ============== -->
    <!-- Script original de la calculadora -->
    <script type="module" src="main.js"></script>

    <!-- Script de Bootstrap (necesario para el sidebar y modal) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Nuevo script con TODA la lógica del lector de números y el modal -->
    <script>
        // ====== INICIO: CÓDIGO COMPLETO DE LA APP "LECTOR DE NÚMEROS" ======
        const NumberConverter = {
            _unidades: ["", "uno", "dos", "tres", "cuatro", "cinco", "seis", "siete", "ocho", "nueve"],
            _especiales: ["diez", "once", "doce", "trece", "catorce", "quince"],
            _decenas: ["", "", "veinte", "treinta", "cuarenta", "cincuenta", "sesenta", "setenta", "ochenta", "noventa"],
            _centenas: ["", "cien", "doscientos", "trescientos", "cuatrocientos", "quinientos", "seiscientos", "setecientos", "ochocientos", "novecientos"],
            _decimalPlaces: ["", "DÉCIMOS", "CENTÉSIMOS", "MILÉSIMOS", "DIEZMILÉSIMOS", "CIENMILÉSIMOS", "MILLONÉSIMOS"],
            toLetters(n) { if (isNaN(n) || n === null) return ""; if (n === 0) return "cero"; if (n < 0) return "menos " + this.toLetters(Math.abs(n)); let t = ""; if (n >= 1e6) { const o = Math.floor(n / 1e6); t += (1 === o ? "un millón" : this.toLetters(o) + " millones"); n %= 1e6; if (n > 0) t += " "; } if (n >= 1e3) { const o = Math.floor(n / 1e3); if (1 === o) { t += "mil"; } else { let e = this.toLetters(o); if (e.endsWith("uno")) e = e.slice(0, -1) + "ún"; t += e + " mil"; } n %= 1e3; if (n > 0) t += " "; } if (n >= 100) { const o = Math.floor(n / 100); t += (1 === o && n % 100 > 0 ? "ciento" : this._centenas[o]); n %= 100; if (n > 0) t += " "; } if (n > 0) { if (n >= 10 && n <= 15) t += this._especiales[n - 10]; else if (n >= 16 && n <= 19) t += "dieci" + this._unidades[n - 10]; else if (n === 20) t += "veinte"; else if (n > 20 && n < 30) t += "veinti" + this._unidades[n - 20]; else if (n >= 30) { const o = Math.floor(n / 10); t += this._decenas[o]; if ((n %= 10) > 0) t += " y " + this._unidades[n]; } else { t += this._unidades[n]; } } return t.trim(); },
            formalDecimalsToLetters(d) { if (!d) return { texto: "", unidad: "" }; const n = parseInt(d, 10); const l = d.length; let t = this.toLetters(n); let u = this._decimalPlaces[l] ? this._decimalPlaces[l].toLowerCase().replace("_", "") : ""; if (n === 1 && u.endsWith("s")) { u = u.slice(0, -1); } return { texto: t, unidad: u }; },
            simpleDecimalsToLetters(d) { return d.split('').map(c => this._unidades[parseInt(c, 10)]).join(' '); }
        };
        const Syllabifier = { syllabify(p) { p = p.toLowerCase().trim(); if (p.length <= 3) return [p]; p = p.replace(/y/g, "i"); let s = [], i = 0; while (i < p.length) { let t = i; while (t < p.length && !/[aeiouáéíóú]/.test(p[t])) t++; while (t < p.length && /[aeiouáéíóú]/.test(p[t])) t++; let c = t; if (t < p.length - 1) { const e = p.substring(t).match(/^[^aeiouáéíóú]+/); if (e) { const n = e[0]; if (n.length === 1 || (n.length === 2 && /^(ll|rr|ch|[bcdfghprt]l|[bcdfghprt]r)$/.test(n))) c = t; else if (n.length >= 2) c = t + 1; } } else c = p.length; s.push(p.substring(i, c)); i = c; } return s.filter(Boolean); } };
        const SpeechService = { speak(text, lang = 'es-ES', onBoundaryCallback = null, onEndCallback = null) { if (!text || typeof window.speechSynthesis === 'undefined') { if(onEndCallback) onEndCallback(); return; } window.speechSynthesis.cancel(); const utterance = new SpeechSynthesisUtterance(text); utterance.lang = lang; if (onBoundaryCallback) { utterance.onboundary = onBoundaryCallback; } if (onEndCallback) { utterance.onend = onEndCallback; } window.speechSynthesis.speak(utterance); } };
        const FormalMode = {
            element: null, placeholder: '<span class="placeholder-text">Representación gráfica...</span>', init(selector) { this.element = document.querySelector(selector); this.reset(); }, reset() { this.element.innerHTML = this.placeholder; },
            render(pEnteraStr, pDecimalStr) { this.element.innerHTML = ''; const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg"); this.element.appendChild(svg); const digitWidth = 55, startX = 40, numY = 160, mainLabelY = 100, verticalLabelY = 80, fontSize = 72, viewBoxHeight = 220; let currentX = startX; const integerBlockWidth = pEnteraStr.length * digitWidth; const integerBlockCenterX = currentX + (integerBlockWidth / 2); svg.innerHTML += `<text x="${integerBlockCenterX}" y="${mainLabelY}" class="svg-etiqueta-principal" text-anchor="middle">PARTE ENTERA</text>`; svg.innerHTML += `<rect x="${currentX - 5}" y="${numY - fontSize + 10}" width="${integerBlockWidth + 10}" height="${fontSize}" fill="var(--ln-color-fondo)" />`; svg.innerHTML += `<text id="svg-entero-texto" x="${integerBlockCenterX}" y="${numY}" class="svg-numero" style="fill: var(--ln-color-entero)" text-anchor="middle">${pEnteraStr}</text>`; currentX += integerBlockWidth + 10; if (pEnteraStr && pDecimalStr) { svg.innerHTML += `<text x="${currentX + 5}" y="${numY - 10}" class="svg-numero" style="fill: var(--ln-color-coma)">,</text>`; currentX += 25; } const gDecimales = document.createElementNS("http://www.w3.org/2000/svg", "g"); gDecimales.id = "svg-decimales-g"; const gEtiquetas = document.createElementNS("http://www.w3.org/2000/svg", "g"); gEtiquetas.id = "svg-etiquetas-g"; svg.appendChild(gDecimales); svg.appendChild(gEtiquetas); let startDecimalX = currentX; const decimalPlaces = NumberConverter._decimalPlaces; pDecimalStr.split('').forEach((digit, index) => { if (index < decimalPlaces.length - 1) { const digitCenterX = currentX + (digitWidth / 2); gDecimales.innerHTML += `<rect x="${currentX}" y="${numY - fontSize + 10}" width="${digitWidth}" height="${fontSize}" fill="var(--ln-color-fondo)" />`; gDecimales.innerHTML += `<text x="${digitCenterX}" y="${numY}" class="svg-numero" style="fill: var(--ln-color-decimal)" text-anchor="middle">${digit}</text>`; gEtiquetas.innerHTML += `<line x1="${currentX + digitWidth}" y1="40" x2="${currentX + digitWidth}" y2="${viewBoxHeight}" stroke="#ccc" stroke-dasharray="5,5" />`; gEtiquetas.innerHTML += `<text x="${digitCenterX}" y="${verticalLabelY}" class="svg-etiqueta-vertical" transform="rotate(-90 ${digitCenterX},${verticalLabelY})">${decimalPlaces[index + 1].replace("_", "")}</text>`; currentX += digitWidth; } }); gEtiquetas.innerHTML += `<line x1="${startDecimalX - 10}" y1="40" x2="${startDecimalX - 10}" y2="${viewBoxHeight}" stroke="var(--ln-color-entero)" stroke-width="3" stroke-dasharray="8,4" />`; svg.setAttribute('viewBox', `0 0 ${currentX + 20} ${viewBoxHeight}`); },
            play({ fullText, integerText, decimalText, unitText }) { if (!fullText) return; const enteroSVG = document.getElementById('svg-entero-texto'); const decimalSVG = document.getElementById('svg-decimales-g'); const etiquetaSVG = document.getElementById('svg-etiquetas-g'); const onBoundary = (e) => { if (e.name !== 'word') return; const currentText = fullText.substring(0, e.charIndex + e.charLength); [enteroSVG, decimalSVG, etiquetaSVG].forEach(el => el && el.classList.remove('highlight')); if(decimalSVG) Array.from(decimalSVG.children).forEach(el => el.classList.remove('highlight')); if (enteroSVG && integerText && currentText.includes(integerText)) enteroSVG.classList.add('highlight'); if (decimalSVG && decimalText && currentText.includes(decimalText)) decimalSVG.querySelectorAll('text').forEach(el => el.classList.add('highlight')); if (etiquetaSVG && unitText && currentText.includes(unitText)) { decimalSVG.querySelectorAll('text').forEach(el => el.classList.remove('highlight')); etiquetaSVG.classList.add('highlight'); } }; const onEnd = () => [enteroSVG, decimalSVG, etiquetaSVG].forEach(el => el && el.classList.remove('highlight')); SpeechService.speak(fullText, 'es-ES', onBoundary, onEnd); }
        };
        const PhoneticMode = {
            element: null, placeholder: '<span class="placeholder-text">Desglose fonético...</span>', init(selector) { this.element = document.querySelector(selector); this.reset(); },
            reset() { this.element.innerHTML = this.placeholder; }, render(text) { this.element.innerHTML = ''; if (!text) { this.reset(); return; } text.split(/\s+/).filter(Boolean).forEach((palabra, index) => { const span = document.createElement('span'); span.className = 'palabra-fonetica'; let silabas = Syllabifier.syllabify(palabra).join('-'); span.textContent = (index === 0) ? silabas.charAt(0).toUpperCase() + silabas.slice(1) : silabas; this.element.appendChild(span); }); },
            play(text) { if (!text) return; const syllables = Array.from(this.element.querySelectorAll('.palabra-fonetica')); let wordIndex = 0; const onBoundary = (event) => { if (event.name === 'word') { syllables.forEach(s => s.classList.remove('highlight')); if (syllables[wordIndex]) { syllables[wordIndex].classList.add('highlight'); } wordIndex++; } }; const onEnd = () => syllables.forEach(s => s.classList.remove('highlight')); SpeechService.speak(text, 'es-ES', onBoundary, onEnd); }
        };
        const App = {
            elements: { input: null, simpleResultDiv: null, playSimpleBtn: null, playPhoneticBtn: null, playFormalBtn: null }, state: { simpleText: "", formalText: "", integerText: "", decimalText: "", unitText: "" },
            placeholders: { simple: '<span class="placeholder-text">La lectura del número aparecerá aquí.</span>' }, init() { this.elements.input = document.getElementById("numero"); this.elements.simpleResultDiv = document.getElementById("resultado"); this.elements.playSimpleBtn = document.getElementById("play-simple-btn"); this.elements.playPhoneticBtn = document.getElementById("play-phonetic-btn"); this.elements.playFormalBtn = document.getElementById("play-formal-btn"); if(!this.elements.input) return; PhoneticMode.init("#aprendizaje-fonetico-resultado"); FormalMode.init("#aprendizaje-formal-wrapper"); this.elements.input.addEventListener("input", this.handleInput.bind(this)); this.elements.playSimpleBtn.addEventListener("click", this.playSimple.bind(this)); this.elements.playPhoneticBtn.addEventListener("click", this.playPhonetic.bind(this)); this.elements.playFormalBtn.addEventListener("click", this.playFormal.bind(this)); this.resetUI(); },
            handleInput() { let val = this.elements.input.value.replace(/[^0-9,]/g, '').replace(/,/g, (m, o, s) => o === s.indexOf(',') ? ',' : ''); if (this.elements.input.value !== val) { this.elements.input.value = val; } if (!val) { this.resetUI(); return; } const parts = val.split(','); const pEnteraStr = parts[0] || '0'; const pDecimalStr = parts[1] || ''; const pEnteraNum = parseInt(pEnteraStr, 10); this.state.integerText = NumberConverter.toLetters(pEnteraNum); const simpleDecimalText = pDecimalStr ? ` coma ${NumberConverter.simpleDecimalsToLetters(pDecimalStr)}` : ""; this.state.simpleText = this.state.integerText + simpleDecimalText; const { texto, unidad } = NumberConverter.formalDecimalsToLetters(pDecimalStr); this.state.decimalText = texto; this.state.unitText = unidad; let fraseEntera = pEnteraNum === 1 && pEnteraStr.length === 1 ? "un entero" : `${this.state.integerText} enteros`; if (pEnteraStr === "0" && pDecimalStr.length > 0) fraseEntera = "cero enteros"; if (pDecimalStr) { this.state.formalText = `${fraseEntera} y ${this.state.decimalText} ${this.state.unitText}`; } else { this.state.formalText = this.state.integerText; } this.renderUI(pEnteraStr, pDecimalStr); },
            renderUI(pEnteraStr, pDecimalStr) { this.elements.simpleResultDiv.textContent = this.state.simpleText.charAt(0).toUpperCase() + this.state.simpleText.slice(1); PhoneticMode.render(this.state.simpleText); FormalMode.render(pEnteraStr, pDecimalStr); },
            resetUI() { this.state = { simpleText: "", formalText: "", integerText: "", decimalText: "", unitText: "" }; if(this.elements.simpleResultDiv) this.elements.simpleResultDiv.innerHTML = this.placeholders.simple; PhoneticMode.reset(); FormalMode.reset(); },
            playSimple() { if (!this.state.simpleText) return; SpeechService.speak(this.state.simpleText); }, playPhonetic() { if (!this.state.simpleText) return; PhoneticMode.play(this.state.simpleText); },
            playFormal() { if (!this.state.formalText) return; FormalMode.play({ fullText: this.state.formalText, integerText: this.state.integerText, decimalText: this.state.decimalText, unitText: this.state.unitText }); }
        };

        // ====== ORQUESTADOR PRINCIPAL DE BOOTSTRAP ======
        document.addEventListener('DOMContentLoaded', () => {
            const tooltipTriggerList = Array.from(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.forEach(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

            const infoModalEl = document.getElementById('infoModal');
            const infoModal = new bootstrap.Modal(infoModalEl);
            const modalTitle = document.getElementById('infoModalLabel');
            const modalBody = document.getElementById('infoModalBody');
            
            const infoData = {
                readNumbers: { title: "Lector de Números Avanzado", body: `<div class="input-section"><label for="numero">Introduce el número:</label><input type="text" id="numero" placeholder="Ej: 1234,56" autocomplete="off"></div><div class="card"><h2>Lectura Simple</h2><div id="resultado" class="result-box"><span class="placeholder-text">...</span></div><button id="play-simple-btn" class="play-btn">▶️ Escuchar</button></div><div class="card"><h2>Modo de Aprendizaje Fonético</h2><div id="aprendizaje-fonetico-resultado" class="result-box phonetic-box"><span class="placeholder-text">...</span></div><button id="play-phonetic-btn" class="play-btn">▶️ Escuchar y Resaltar</button></div><div class="card"><h2>Modo de Aprendizaje Formal (Gráfico)</h2><div id="aprendizaje-formal-wrapper" class="result-box svg-box"><span class="placeholder-text">...</span></div><button id="play-formal-btn" class="play-btn">▶️ Escuchar y Resaltar</button></div>`, onShow: App.init.bind(App) },
                geometry: { title: "Conceptos de Geometría", body: `<p>Un resumen visual de las fórmulas de área y perímetro. (Contenido en construcción).</p>` },
                config: { title: "Panel de Configuración", body: `<p>Modulo en construccion 🧐.</p>` },
                help: { title: "Centro de Ayuda", body: `<p>Encuentra respuestas a preguntas frecuentes (FAQ).</p>` }
            };
            
            document.querySelectorAll('[data-modal-target]').forEach(trigger => {
                trigger.addEventListener('click', () => {
                    const targetKey = trigger.dataset.modalTarget; const data = infoData[targetKey];
                    if (data) {
                        modalTitle.textContent = data.title; modalBody.innerHTML = data.body; infoModal.show();
                        if (data.onShow) { infoModalEl.addEventListener('shown.bs.modal', data.onShow, { once: true }); }
                    }
                });
            });

            infoModalEl.addEventListener('hide.bs.modal', () => { if (window.speechSynthesis) window.speechSynthesis.cancel(); });
            
            // ===================================================================
            // === LÓGICA PARA CONECTAR HISTORIAL CON LECTOR DE NÚMEROS ===
            // ===================================================================
            const historyList = document.getElementById('history-list');
            const historyPanel = document.getElementById('history-panel');

            historyList.addEventListener('click', (event) => {
                // 1. Comprobar si el modal del lector de números está visible
                // y si el campo de entrada del lector existe (por si es otro modal)
                if (!infoModalEl.classList.contains('show') || !document.getElementById('numero')) {
                    return; 
                }

                // 2. Encontrar el item del historial y el resultado en el que se hizo clic
                const clickedItem = event.target.closest('.history-panel__item');
                if (!clickedItem) return;

                const resultSpan = clickedItem.querySelector('.history-panel__result');
                if (!resultSpan) return;
                
                // 3. Obtener el número y prepararlo para el lector (usa ',' en vez de '.')
                let numberToSet = resultSpan.textContent.trim().replace(/\./g, ',');
                
                // 4. Encontrar el campo de entrada del lector y poner el número
                const numberReaderInput = document.getElementById('numero');
                numberReaderInput.value = numberToSet;
                
                // 5. ¡CRÍTICO! Disparar el evento 'input' para que la App del lector reaccione
                // Esto simula que el usuario ha tecleado el número, forzando la actualización.
                numberReaderInput.dispatchEvent(new Event('input', { bubbles: true }));

                // 6. (Opcional) Cerrar el panel de historial para una mejor experiencia de usuario
                historyPanel.classList.remove('history-panel--open');
            });
        });
    </script>
</body>
</html>
